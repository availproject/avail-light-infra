---

- name: Remove any existing versions
  shell: rm /usr/local/bin/avail* /opt/avail* || true
  ignore_errors: true
  
- name: Download {{ client_role }} binary
  block:
    - name: Download {{ client_role }} archive on x86_64 architecture
      register: avail_download_results
      ansible.builtin.get_url:
        url: https://github.com/availproject/{{ client_role }}/releases/download/{{ client_version }}/{{ client_role }}-linux-amd64.tar.gz
        dest: /opt/avail_light_{{ client_version }}_linux_amd.tar.gz
        mode: 0600
        force: false
        timeout: 300
      when: ansible_architecture == "x86_64"
    - name: Download {{ client_role }} archive on aarch64 architecture
      register: avail_download_results
      ansible.builtin.get_url:
        url: https://github.com/availproject/{{ client_role }}/releases/download/{{ client_version }}/{{ client_role }}-linux-arm64.tar.gz #arm64 or aarch64
        dest: /opt/avail_light_{{ client_version }}_linux_aarch64.tar.gz
        mode: 0600
        force: false
        timeout: 300
      when: ansible_architecture == "aarch64"

- name: Extract {{ client_role }} archive
  block:
    - name: Extract {{ client_role }} archive on x86_64 architecture
      ansible.builtin.unarchive:
        src: /opt/avail_light_{{ client_version }}_linux_amd.tar.gz
        dest: /opt
        remote_src: true
      when: ansible_architecture == "x86_64"
    - name: Extract {{ client_role }} archive on aarch64 architecture
      ansible.builtin.unarchive:
        src: /opt/avail_light_{{ client_version }}_linux_aarch64.tar.gz
        dest: /opt
        remote_src: true
      when: ansible_architecture == "aarch64"

- name: Create a symbolic link for {{ client_role }}
  block:
    - name: Create a symbolic link on x86_64 architecture
      ansible.builtin.file:
        src: /opt/{{ client_role }}-linux-amd64
        dest: /usr/local/bin/{{ client_role }}-{{ client_version }}
        state: link
      when: ansible_architecture == "x86_64"
    - name: Create a symbolic link on aarch64 architecture
      ansible.builtin.file:
        src: /opt/{{ client_role }}-linux-arm64 #arm64 or aarch64
        dest: /usr/local/bin/{{ client_role }}-{{ client_version }}
        state: link
      when: ansible_architecture == "aarch64"